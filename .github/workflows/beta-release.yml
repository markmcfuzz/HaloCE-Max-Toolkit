name: Beta Release

on:
  push:
    branches:
      - beta

jobs:
  prerelease:
    name: Generate Beta Pre-release
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LuaJIT
        run: |
          choco install luajit -y
        shell: powershell

      - name: Run build script
        run: |
          cd build
          luajit create_mzp.lua
          cd ..
        shell: powershell

      - name: Find generated MZP
        id: mzp
        run: |
          $file = Get-ChildItem -Recurse -Filter *.mzp | Select-Object -First 1
          if (-not $file) {
            Write-Error "No MZP file found"
            exit 1
          }
          echo "MZP_FILE=$($file.FullName)" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Set version
        id: version
        run: |
          $lastBeta = git tag --list "v*-beta.*" | Sort-Object -Version | Select-Object -Last 1
          Write-Host "Last beta tag: $lastBeta"

          if (-not $lastBeta) {
            $baseVersion = "v3.6.0"   # <-- Ajusta la siguiente versión aquí
            $nextBeta = 1
          } else {
            $baseVersion = $lastBeta -replace "-beta.*",""
            $currentBeta = ($lastBeta -replace ".*-beta.","") -as [int]
            $nextBeta = $currentBeta + 1
          }

          $newTag = "$baseVersion-beta.$nextBeta"
          Write-Host "Generated tag: $newTag"
          echo "NEW_TAG=$newTag" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Create tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag $env:NEW_TAG
          git push origin $env:NEW_TAG
        shell: powershell

      - name: Create Pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.NEW_TAG }}
          prerelease: true
          generate_release_notes: true
          files: |
            ${{ steps.mzp.outputs.MZP_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
