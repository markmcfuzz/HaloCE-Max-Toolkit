name: Beta Release

on:
  push:
    branches:
      - beta

jobs:
  prerelease:
    name: Generate Beta Pre-release
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run Python build script
        run: |
          python build/create_mzp.py
        shell: powershell

      - name: Find generated MZP
        id: mzp
        run: |
          $file = Get-ChildItem -Recurse -Filter *.mzp | Select-Object -First 1
          if (-not $file) {
            Write-Error "No MZP file found"
            exit 1
          }
          echo "MZP_FILE=$($file.FullName)" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Set version
        id: version
        run: |
          # Leer versión base desde manifest.json
          $manifest = Get-Content build/manifest.json | ConvertFrom-Json
          $baseVersion = "v$($manifest.packageVersion)"

          Write-Host "Base version from manifest.json: $baseVersion"

          # Buscar tags beta existentes
          $betaTags = git tag --list "$baseVersion-beta.*"

          if ($betaTags.Count -eq 0) {
            $nextBeta = 1
          } else {
            # Extraer números beta de los tags encontrados
            $betaNumbers = $betaTags | ForEach-Object {
              ($_ -replace "^$baseVersion-beta\.", "") -as [int]
            }

            $nextBeta = ($betaNumbers | Measure-Object -Maximum).Maximum + 1
          }

          $newTag = "$baseVersion-beta.$nextBeta"
          Write-Host "Generated tag: $newTag"

          echo "NEW_TAG=$newTag" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Create tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag $env:NEW_TAG
          git push origin $env:NEW_TAG
        shell: powershell

      - name: Create Pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.NEW_TAG }}
          prerelease: true
          generate_release_notes: true
          files: |
            ${{ steps.mzp.outputs.MZP_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
