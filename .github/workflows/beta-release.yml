name: Beta Release

on:
  push:
    branches:
      - beta
    paths:
      - 'src/**'

permissions:
  contents: write

jobs:
  prerelease:
    name: Generate Beta Pre-release
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run Python build script
        run: |
          python build/create_mzp.py
        shell: powershell

      - name: Find generated MZP
        id: mzp
        run: |
          $file = Get-ChildItem -Recurse -Filter *.mzp | Select-Object -First 1
          if (-not $file) {
            Write-Error "No MZP file found"
            exit 1
          }
          echo "MZP_FILE=$($file.FullName)" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Set version
        id: version
        run: |
          $manifest = Get-Content build/manifest.json | ConvertFrom-Json
          $baseVersion = "v$($manifest.packageVersion)"
          $versionNumber = $manifest.packageVersion

          Write-Host "Base version from manifest.json: $baseVersion"

          $newTag = "$baseVersion-beta"
          Write-Host "Generated tag: $newTag"

          # We'll use a simplified version without the date since dates can vary
          $changelogAnchor = $versionNumber -replace '\.', ''
          
          echo "NEW_TAG=$newTag" >> $env:GITHUB_OUTPUT
          echo "VERSION_NUMBER=$versionNumber" >> $env:GITHUB_OUTPUT
          echo "CHANGELOG_ANCHOR=$changelogAnchor" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Extract version changes from CHANGELOG
        id: changelog
        run: |
          $version = "${{ steps.version.outputs.VERSION_NUMBER }}"
          $changelog = Get-Content CHANGELOG.md -Raw
          
          # Extract the section for this version including the header to get the date
          $pattern = "(?s)## \[$version\] - (\d{4}-\d{2}-\d{2}).*?(?=## \[|$)"
          if ($changelog -match $pattern) {
            $date = $matches[1]
            $versionChanges = $matches[0].Trim()
            
            # Create the GitHub anchor (e.g., "3.6.1" and "2025-12-07" -> "361---2025-12-07")
            $anchor = "$($version -replace '\.', '')---$date"
            
            # Remove the version header line for cleaner output in body
            $versionChanges = ($versionChanges -split "`n" | Select-Object -Skip 1) -join "`n"
            $versionChanges = $versionChanges.Trim()
          } else {
            $versionChanges = "No changelog entry found for version $version"
            $anchor = ""
          }
          
          # Escape for GitHub output
          $versionChanges = $versionChanges -replace '%', '%25'
          $versionChanges = $versionChanges -replace "`r", '%0D'
          $versionChanges = $versionChanges -replace "`n", '%0A'
          
          echo "CHANGES=$versionChanges" >> $env:GITHUB_OUTPUT
          echo "ANCHOR=$anchor" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Create tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Delete existing tag if it exists (both locally and remotely)
          $tagExists = git tag -l $env:NEW_TAG
          if ($tagExists) {
            Write-Host "Tag $env:NEW_TAG already exists. Deleting..."
            git tag -d $env:NEW_TAG
            git push --delete origin $env:NEW_TAG 2>$null
          }
          
          # Create and push new tag
          git tag $env:NEW_TAG
          git push origin $env:NEW_TAG
        shell: powershell

      - name: Create Pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.NEW_TAG }}
          prerelease: true
          body: |
            ## Beta Pre-release - v${{ steps.version.outputs.VERSION_NUMBER }}
            
            This is a beta pre-release for testing purposes.
            
            **Full Changelog:** [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md#${{ steps.changelog.outputs.ANCHOR }})
          files: |
            ${{ steps.mzp.outputs.MZP_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
