name: Beta Release

on:
  push:
    branches:
      - beta
    paths:
      - 'src/**'

permissions:
  contents: write

jobs:
  prerelease:
    name: Generate Beta Pre-release
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run Python build script
        run: |
          python build/create_mzp.py
        shell: powershell

      - name: Find generated MZP
        id: mzp
        run: |
          $file = Get-ChildItem -Recurse -Filter *.mzp | Select-Object -First 1
          if (-not $file) {
            Write-Error "No MZP file found"
            exit 1
          }
          echo "MZP_FILE=$($file.FullName)" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Set version
        id: version
        run: |
          # Leer versiÃ³n base desde manifest.json
          $manifest = Get-Content build/manifest.json | ConvertFrom-Json
          $baseVersion = "v$($manifest.packageVersion)"

          Write-Host "Base version from manifest.json: $baseVersion"

          $newTag = "$baseVersion-beta"
          Write-Host "Generated tag: $newTag"

          echo "NEW_TAG=$newTag" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Create tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Delete existing tag if it exists (both locally and remotely)
          $tagExists = git tag -l $env:NEW_TAG
          if ($tagExists) {
            Write-Host "Tag $env:NEW_TAG already exists. Deleting..."
            git tag -d $env:NEW_TAG
            git push --delete origin $env:NEW_TAG 2>$null
          }
          
          # Create and push new tag
          git tag $env:NEW_TAG
          git push origin $env:NEW_TAG
        shell: powershell

      - name: Create Pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.NEW_TAG }}
          prerelease: true
          body: |
            ## Beta Pre-release
            This is a beta pre-release for testing purposes.
            
            ðŸ“‹ **Full Changelog:** [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md)
          files: |
            ${{ steps.mzp.outputs.MZP_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
