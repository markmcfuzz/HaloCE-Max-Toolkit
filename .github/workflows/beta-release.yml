name: Beta Release

on:
  push:
    branches:
      - beta
    paths:
      - 'HCEMaxToolkit/**'

permissions:
  contents: write

jobs:
  prerelease:
    name: Generate Beta Pre-release
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version and beta number
        id: version
        run: |
          # Extract the latest version from CHANGELOG.md (last occurrence)
          $changelog = Get-Content CHANGELOG.md
          $versionLine = $changelog | Where-Object { $_ -match '^## \[(\d+\.\d+\.\d+)\]' } | Select-Object -Last 1
          
          if ($versionLine -match '^## \[(\d+\.\d+\.\d+)\]') {
            $version = $matches[1]
            Write-Host "Found latest version in CHANGELOG: $version"
          } else {
            Write-Error "Could not find version in CHANGELOG.md. Expected format: ## [1.0.0]"
            exit 1
          }
          
          # Count existing beta tags for this version to auto-increment
          $existingTags = git tag -l "v$version-beta.*"
          if ($existingTags) {
            $betaNumbers = $existingTags | ForEach-Object {
              if ($_ -match 'beta\.(\d+)$') { [int]$matches[1] }
            }
            $betaNumber = ($betaNumbers | Measure-Object -Maximum).Maximum + 1
          } else {
            $betaNumber = 1
          }
          
          $newTag = "v$version-beta.$betaNumber"
          Write-Host "Version: $version"
          Write-Host "Beta Number: $betaNumber"
          Write-Host "Tag: $newTag"
          
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "BETA_NUMBER=$betaNumber" >> $env:GITHUB_OUTPUT
          echo "NEW_TAG=$newTag" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Extract changelog info
        id: changelog
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $changelog = Get-Content CHANGELOG.md -Raw
          
          # Extract the section for this version to get the date
          $pattern = "(?s)## \[$version\] - (\d{4}-\d{2}-\d{2})"
          if ($changelog -match $pattern) {
            $date = $matches[1]
            # Create the GitHub anchor (e.g., "3.6.3" and "2025-12-08" -> "363---2025-12-08")
            $anchor = "$($version -replace '\.', '')---$date"
            Write-Host "Changelog anchor: $anchor"
            echo "ANCHOR=$anchor" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No changelog entry found for version $version"
            echo "ANCHOR=" >> $env:GITHUB_OUTPUT
          }
        shell: powershell

      - name: Create tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Delete existing tag if it exists (both locally and remotely)
          $tagExists = git tag -l "${{ steps.version.outputs.NEW_TAG }}"
          if ($tagExists) {
            Write-Host "Tag ${{ steps.version.outputs.NEW_TAG }} already exists. Deleting..."
            git tag -d "${{ steps.version.outputs.NEW_TAG }}"
            git push --delete origin "${{ steps.version.outputs.NEW_TAG }}" 2>$null
          }
          
          # Create and push new tag
          git tag "${{ steps.version.outputs.NEW_TAG }}"
          git push origin "${{ steps.version.outputs.NEW_TAG }}"
        shell: powershell

      - name: Create ZIP
        id: create_zip
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $betaNumber = "${{ steps.version.outputs.BETA_NUMBER }}"
          $zipName = "halo-ce-max-toolkit-$version-beta.$betaNumber.zip"
          
          Write-Host "Creating ZIP: $zipName"
          
          # Create zip from HCEMaxToolkit folder
          Compress-Archive -Path "HCEMaxToolkit\*" -DestinationPath $zipName -Force
          
          if (Test-Path $zipName) {
            Write-Host "ZIP created successfully: $zipName"
            echo "ZIP_FILE=$zipName" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "Failed to create ZIP file"
            exit 1
          }
        shell: powershell

      - name: Create Pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.NEW_TAG }}
          name: "${{ steps.version.outputs.NEW_TAG }}"
          prerelease: true
          body: |
            ## Beta Pre-release - v${{ steps.version.outputs.VERSION }}
            
            This is a beta pre-release for testing purposes.
            Extract the zip on next path: `C:\Users\yourUserName\AppData\Roaming\Autodesk\ApplicationPlugins`
            
            **Full Changelog:** [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/beta/CHANGELOG.md#${{ steps.changelog.outputs.ANCHOR }})
          files: |
            ${{ steps.create_zip.outputs.ZIP_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
